stages:
  - build
  - publish

build:
  stage: build
  tags:
    - docker
  image: registry.gitlab.com/tarantool/enterprise/central:latest

  before_script:
    - yum -y install https://centos7.iuscommunity.org/ius-release.rpm
    - curl -sL https://rpm.nodesource.com/setup_8.x | bash -
    - yum -y install cmake unzip python python-pip nodejs
    - tarantoolctl rocks install ldoc --server=http://rocks.moonscript.org
    - export PATH=.rocks/bin:$PATH
    - pip install -r pytest/requirements.txt
  script:
    - tarantoolctl rocks make
    - pytest -v
    - ./taptest.lua
    - ./release.sh
    - make doc
  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
      - doc/
      - release/
      - release-doc/

publish:
  stage: publish
  dependencies:
    - build
  tags:
    - shell
  when: manual
  only:
    - tags
  script:
    - aws --endpoint-url "${AWS_S3_ENDPOINT_URL}" s3 cp release/*.all.rock "s3://packages/rocks/"
    - aws --endpoint-url "${AWS_S3_ENDPOINT_URL}" s3 cp --recursive release-doc/ "s3://packages/rocks-doc/"
